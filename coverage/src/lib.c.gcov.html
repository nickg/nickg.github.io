<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - nvc.info - src/lib.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">src</a> - lib.c<span style="font-size: 80%;"> (source / <a href="lib.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">nvc.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">317</td>
            <td class="headerCovTableEntry">379</td>
            <td class="headerCovTableEntryMed">83.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-08-31</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntry">39</td>
            <td class="headerCovTableEntryMed">87.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //</a>
<span class="lineNum">       2 </span>            : //  Copyright (C) 2011-2017  Nick Gasson
<span class="lineNum">       3 </span>            : //
<span class="lineNum">       4 </span>            : //  This program is free software: you can redistribute it and/or modify
<span class="lineNum">       5 </span>            : //  it under the terms of the GNU General Public License as published by
<span class="lineNum">       6 </span>            : //  the Free Software Foundation, either version 3 of the License, or
<span class="lineNum">       7 </span>            : //  (at your option) any later version.
<span class="lineNum">       8 </span>            : //
<span class="lineNum">       9 </span>            : //  This program is distributed in the hope that it will be useful,
<span class="lineNum">      10 </span>            : //  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      11 </span>            : //  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      12 </span>            : //  GNU General Public License for more details.
<span class="lineNum">      13 </span>            : //
<span class="lineNum">      14 </span>            : //  You should have received a copy of the GNU General Public License
<span class="lineNum">      15 </span>            : //  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
<span class="lineNum">      16 </span>            : //
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #define _GNU_SOURCE
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;util.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;lib.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;tree.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;common.h&quot;
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : #include &lt;assert.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;limits.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;ctype.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;dirent.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;errno.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;time.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;fcntl.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;sys/time.h&gt;
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : typedef struct search_path search_path_t;
<span class="lineNum">      40 </span>            : typedef struct lib_unit    lib_unit_t;
<span class="lineNum">      41 </span>            : typedef struct lib_index   lib_index_t;
<span class="lineNum">      42 </span>            : typedef struct lib_list    lib_list_t;
<span class="lineNum">      43 </span>            : typedef struct lib_map     lib_map_t;
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : struct lib_unit {
<span class="lineNum">      46 </span>            :    tree_t        top;
<span class="lineNum">      47 </span>            :    tree_kind_t   kind;
<span class="lineNum">      48 </span>            :    tree_rd_ctx_t read_ctx;
<span class="lineNum">      49 </span>            :    bool          dirty;
<span class="lineNum">      50 </span>            :    lib_mtime_t   mtime;
<span class="lineNum">      51 </span>            : };
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : struct lib_index {
<span class="lineNum">      54 </span>            :    ident_t      name;
<span class="lineNum">      55 </span>            :    tree_kind_t  kind;
<span class="lineNum">      56 </span>            :    lib_index_t *next;
<span class="lineNum">      57 </span>            : };
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : struct lib {
<span class="lineNum">      60 </span>            :    char         path[PATH_MAX];
<span class="lineNum">      61 </span>            :    ident_t      name;
<span class="lineNum">      62 </span>            :    unsigned     n_units;
<span class="lineNum">      63 </span>            :    unsigned     units_alloc;
<span class="lineNum">      64 </span>            :    lib_unit_t  *units;
<span class="lineNum">      65 </span>            :    lib_index_t *index;
<span class="lineNum">      66 </span>            :    int          lock_fd;
<span class="lineNum">      67 </span>            : };
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            : struct lib_list {
<span class="lineNum">      70 </span>            :    lib_t       item;
<span class="lineNum">      71 </span>            :    lib_list_t *next;
<span class="lineNum">      72 </span>            : };
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : struct search_path {
<span class="lineNum">      75 </span>            :    search_path_t *next;
<span class="lineNum">      76 </span>            :    const char    *path;
<span class="lineNum">      77 </span>            : };
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : static lib_t          work = NULL;
<span class="lineNum">      80 </span>            : static lib_list_t    *loaded = NULL;
<span class="lineNum">      81 </span>            : static search_path_t *search_paths = NULL;
<span class="lineNum">      82 </span>            : 
<a name="83"><span class="lineNum">      83 </span>            : static const char *lib_file_path(lib_t lib, const char *name);</a>
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineCov">       1050 : static const char *standard_suffix(vhdl_standard_t std)</span>
<span class="lineNum">      86 </span>            : {
<span class="lineNum">      87 </span>            :    static const char *ext[] = {
<span class="lineNum">      88 </span>            :       &quot;87&quot;, &quot;93&quot;, &quot;00&quot;, &quot;02&quot;, &quot;08&quot;
<span class="lineNum">      89 </span>            :    };
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span><span class="lineCov">       1050 :    assert(std &lt; ARRAY_LEN(ext));</span>
<span class="lineNum">      92 </span><span class="lineCov">       1050 :    return ext[std];</span>
<a name="93"><span class="lineNum">      93 </span>            : }</a>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineCov">       1673 : static ident_t upcase_name(const char * name)</span>
<span class="lineNum">      96 </span>            : {
<span class="lineNum">      97 </span><span class="lineCov">       3346 :    char *name_copy LOCAL = xstrdup(name);</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">       1673 :    char *last_slash = strrchr(name_copy, '/');</span>
<span class="lineNum">     100 </span><span class="lineCov">       3346 :    while ((last_slash != NULL) &amp;&amp; (*(last_slash + 1) == '\0')) {</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :       *last_slash = '\0';</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :       last_slash = strrchr(name_copy, '/');</span>
<span class="lineNum">     103 </span>            :    }
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span><span class="lineCov">       1673 :    char *name_up = (last_slash != NULL) ? last_slash + 1 : name_copy;</span>
<span class="lineNum">     106 </span><span class="lineCov">       7830 :    for (char *p = name_up; *p != '\0'; p++)</span>
<span class="lineNum">     107 </span><span class="lineCov">       6157 :       *p = toupper((int)*p);</span>
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineCov">       1673 :    char *last_dot = strrchr(name_up, '.');</span>
<span class="lineNum">     110 </span><span class="lineCov">       1673 :    if (last_dot != NULL)</span>
<span class="lineNum">     111 </span><span class="lineCov">          6 :       *last_dot = '\0';</span>
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span><span class="lineCov">       1673 :    ident_t i = ident_new(name_up);</span>
<span class="lineNum">     114 </span><span class="lineCov">       1673 :    return i;</span>
<a name="115"><span class="lineNum">     115 </span>            : }</a>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineCov">       1285 : static lib_t lib_init(const char *name, const char *rpath, int lock_fd)</span>
<span class="lineNum">     118 </span>            : {
<span class="lineNum">     119 </span><span class="lineCov">       1285 :    struct lib *l = xmalloc(sizeof(struct lib));</span>
<span class="lineNum">     120 </span><span class="lineCov">       1285 :    l-&gt;n_units = 0;</span>
<span class="lineNum">     121 </span><span class="lineCov">       1285 :    l-&gt;units   = NULL;</span>
<span class="lineNum">     122 </span><span class="lineCov">       1285 :    l-&gt;name    = upcase_name(name);</span>
<span class="lineNum">     123 </span><span class="lineCov">       1285 :    l-&gt;index   = NULL;</span>
<span class="lineNum">     124 </span><span class="lineCov">       1285 :    l-&gt;lock_fd = lock_fd;</span>
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span><span class="lineCov">       2570 :    if (realpath(rpath, l-&gt;path) == NULL)</span>
<span class="lineNum">     127 </span><span class="lineCov">        290 :       strncpy(l-&gt;path, rpath, PATH_MAX);</span>
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span><span class="lineCov">       1285 :    lib_list_t *el = xmalloc(sizeof(lib_list_t));</span>
<span class="lineNum">     130 </span><span class="lineCov">       1285 :    el-&gt;item = l;</span>
<span class="lineNum">     131 </span><span class="lineCov">       1285 :    el-&gt;next = loaded;</span>
<span class="lineNum">     132 </span><span class="lineCov">       1285 :    loaded = el;</span>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span><span class="lineCov">       1285 :    if (l-&gt;lock_fd == -1) {</span>
<span class="lineNum">     135 </span><span class="lineCov">        650 :       const char *lock_path = lib_file_path(l, &quot;_NVC_LIB&quot;);</span>
<span class="lineNum">     136 </span><span class="lineCov">        650 :       if ((l-&gt;lock_fd = open(lock_path, O_RDONLY)) &lt; 0)</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :          fatal_errno(&quot;lib_init: %s&quot;, lock_path);</span>
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span><span class="lineCov">        650 :       file_read_lock(l-&gt;lock_fd);</span>
<span class="lineNum">     140 </span>            :    }
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineCov">       1285 :    fbuf_t *f = lib_fbuf_open(l, &quot;_index&quot;, FBUF_IN);</span>
<span class="lineNum">     143 </span><span class="lineCov">       1285 :    if (f != NULL) {</span>
<span class="lineNum">     144 </span><span class="lineCov">        649 :       ident_rd_ctx_t ictx = ident_read_begin(f);</span>
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineCov">        649 :       const int entries = read_u32(f);</span>
<span class="lineNum">     147 </span><span class="lineCov">       3167 :       for (int i = 0; i &lt; entries; i++) {</span>
<span class="lineNum">     148 </span><span class="lineCov">       2518 :          ident_t name = ident_read(ictx);</span>
<span class="lineNum">     149 </span><span class="lineCov">       2518 :          tree_kind_t kind = read_u16(f);</span>
<span class="lineNum">     150 </span><span class="lineCov">       2518 :          assert(kind &lt; T_LAST_TREE_KIND);</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span><span class="lineCov">       2518 :          lib_index_t *in = xmalloc(sizeof(lib_index_t));</span>
<span class="lineNum">     153 </span><span class="lineCov">       2518 :          in-&gt;name = name;</span>
<span class="lineNum">     154 </span><span class="lineCov">       2518 :          in-&gt;kind = kind;</span>
<span class="lineNum">     155 </span><span class="lineCov">       2518 :          in-&gt;next = l-&gt;index;</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineCov">       2518 :          l-&gt;index = in;</span>
<span class="lineNum">     158 </span>            :       }
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span><span class="lineCov">        649 :       ident_read_end(ictx);</span>
<span class="lineNum">     161 </span><span class="lineCov">        649 :       fbuf_close(f);</span>
<span class="lineNum">     162 </span>            :    }
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span><span class="lineCov">       1285 :    file_unlock(l-&gt;lock_fd);</span>
<span class="lineNum">     165 </span><span class="lineCov">       1285 :    return l;</span>
<a name="166"><span class="lineNum">     166 </span>            : }</a>
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineCov">       3253 : static lib_index_t *lib_find_in_index(lib_t lib, ident_t name)</span>
<span class="lineNum">     169 </span>            : {
<span class="lineNum">     170 </span>            :    lib_index_t *it;
<span class="lineNum">     171 </span><span class="lineCov">      11411 :    for (it = lib-&gt;index;</span>
<span class="lineNum">     172 </span><span class="lineCov">       6091 :         (it != NULL) &amp;&amp; (it-&gt;name != name);</span>
<span class="lineNum">     173 </span><span class="lineCov">       4905 :         it = it-&gt;next)</span>
<span class="lineNum">     174 </span>            :       ;
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineCov">       3253 :    return it;</span>
<a name="177"><span class="lineNum">     177 </span>            : }</a>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineCov">       6444 : static lib_unit_t *lib_put_aux(lib_t lib, tree_t unit,</span>
<span class="lineNum">     180 </span>            :                                tree_rd_ctx_t ctx, bool dirty,
<span class="lineNum">     181 </span>            :                                lib_mtime_t mtime)
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span><span class="lineCov">       3222 :    assert(lib != NULL);</span>
<span class="lineNum">     184 </span><span class="lineCov">       3222 :    assert(unit != NULL);</span>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineCov">       3222 :    lib_unit_t *where = NULL;</span>
<span class="lineNum">     187 </span><span class="lineCov">       3222 :    ident_t name = tree_ident(unit);</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">       8146 :    for (unsigned i = 0; (where == NULL) &amp;&amp; (i &lt; lib-&gt;n_units); i++) {</span>
<span class="lineNum">     190 </span><span class="lineCov">       4924 :       if (tree_ident(lib-&gt;units[i].top) == tree_ident(unit))</span>
<span class="lineNum">     191 </span><span class="lineCov">         94 :          where = &amp;(lib-&gt;units[i]);</span>
<span class="lineNum">     192 </span>            :    }
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineCov">       3222 :    if (where == NULL) {</span>
<span class="lineNum">     195 </span><span class="lineCov">       3128 :       if (lib-&gt;n_units == 0) {</span>
<span class="lineNum">     196 </span><span class="lineCov">       1223 :          lib-&gt;units_alloc = 16;</span>
<span class="lineNum">     197 </span><span class="lineCov">       1223 :          lib-&gt;units = xmalloc(sizeof(lib_unit_t) * lib-&gt;units_alloc);</span>
<span class="lineNum">     198 </span>            :       }
<span class="lineNum">     199 </span><span class="lineCov">       1905 :       else if (lib-&gt;n_units == lib-&gt;units_alloc) {</span>
<span class="lineNum">     200 </span><span class="lineCov">          1 :          lib-&gt;units_alloc *= 2;</span>
<span class="lineNum">     201 </span><span class="lineCov">          1 :          lib-&gt;units = xrealloc(lib-&gt;units,</span>
<span class="lineNum">     202 </span>            :                                sizeof(lib_unit_t) * lib-&gt;units_alloc);
<span class="lineNum">     203 </span>            :       }
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineCov">       3128 :       where = &amp;(lib-&gt;units[lib-&gt;n_units++]);</span>
<span class="lineNum">     206 </span>            :    }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineCov">       3222 :    where-&gt;top      = unit;</span>
<span class="lineNum">     209 </span><span class="lineCov">       3222 :    where-&gt;read_ctx = ctx;</span>
<span class="lineNum">     210 </span><span class="lineCov">       3222 :    where-&gt;dirty    = dirty;</span>
<span class="lineNum">     211 </span><span class="lineCov">       3222 :    where-&gt;mtime    = mtime;</span>
<span class="lineNum">     212 </span><span class="lineCov">       3222 :    where-&gt;kind     = tree_kind(unit);</span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineCov">       3222 :    lib_index_t *it = lib_find_in_index(lib, name);</span>
<span class="lineNum">     215 </span><span class="lineCov">       3222 :    if (it == NULL) {</span>
<span class="lineNum">     216 </span><span class="lineCov">       2036 :       lib_index_t *new = xmalloc(sizeof(lib_index_t));</span>
<span class="lineNum">     217 </span><span class="lineCov">       2036 :       new-&gt;name = name;</span>
<span class="lineNum">     218 </span><span class="lineCov">       2036 :       new-&gt;kind = tree_kind(unit);</span>
<span class="lineNum">     219 </span><span class="lineCov">       2036 :       new-&gt;next = lib-&gt;index;</span>
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span><span class="lineCov">       2036 :       lib-&gt;index = new;</span>
<span class="lineNum">     222 </span>            :    }
<span class="lineNum">     223 </span>            :    else
<span class="lineNum">     224 </span><span class="lineCov">       1186 :       it-&gt;kind = tree_kind(unit);</span>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineCov">       3222 :    return where;</span>
<a name="227"><span class="lineNum">     227 </span>            : }</a>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineCov">        995 : static lib_t lib_find_at(const char *name, const char *path, bool exact)</span>
<span class="lineNum">     230 </span>            : {
<span class="lineNum">     231 </span>            :    char dir[PATH_MAX];
<span class="lineNum">     232 </span><span class="lineCov">       1990 :    char *p = dir + snprintf(dir, sizeof(dir) - 4 - strlen(name), &quot;%s/&quot;, path);</span>
<span class="lineNum">     233 </span><span class="lineCov">        995 :    bool found = false;</span>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span><span class="lineCov">        995 :    if (!exact) {</span>
<span class="lineNum">     236 </span>            :       // Append library name converting to lower case
<span class="lineNum">     237 </span><span class="lineCov">       3431 :       for (const char *n = name; *n != '\0'; n++)</span>
<span class="lineNum">     238 </span><span class="lineCov">       3431 :          *p++ = tolower((int)*n);</span>
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span>            :       // Try suffixing standard revision extensions first
<span class="lineNum">     241 </span><span class="lineCov">       2044 :       for (vhdl_standard_t s = standard(); (s &gt; STD_87) &amp;&amp; !found; s--) {</span>
<span class="lineNum">     242 </span><span class="lineCov">       1049 :          snprintf(p, 4, &quot;.%s&quot;, standard_suffix(s));</span>
<span class="lineNum">     243 </span><span class="lineCov">       1049 :          found = (access(dir, F_OK) == 0);</span>
<span class="lineNum">     244 </span>            :       }
<span class="lineNum">     245 </span>            :    }
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">        995 :    if (!found) {</span>
<span class="lineNum">     248 </span><span class="lineCov">        986 :       *p = '\0';</span>
<span class="lineNum">     249 </span><span class="lineCov">        986 :       if (access(dir, F_OK) &lt; 0)</span>
<span class="lineNum">     250 </span>            :          return NULL;
<span class="lineNum">     251 </span>            :    }
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            :    char marker[PATH_MAX];
<span class="lineNum">     254 </span>            :    snprintf(marker, sizeof(marker), &quot;%s/_NVC_LIB&quot;, dir);
<span class="lineNum">     255 </span><span class="lineCov">        650 :    if (access(marker, F_OK) &lt; 0)</span>
<span class="lineNum">     256 </span>            :       return NULL;
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineCov">        650 :    return lib_init(name, dir, -1);</span>
<a name="259"><span class="lineNum">     259 </span>            : }</a>
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineCov">      11348 : static const char *lib_file_path(lib_t lib, const char *name)</span>
<span class="lineNum">     262 </span>            : {
<span class="lineNum">     263 </span>            :    static char buf[PATH_MAX];
<span class="lineNum">     264 </span><span class="lineCov">      11348 :    snprintf(buf, sizeof(buf), &quot;%s/%s&quot;, lib-&gt;path, name);</span>
<span class="lineNum">     265 </span><span class="lineCov">      11348 :    return buf;</span>
<a name="266"><span class="lineNum">     266 </span>            : }</a>
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineCov">      10766 : lib_t lib_loaded(ident_t name_i)</span>
<span class="lineNum">     269 </span>            : {
<span class="lineNum">     270 </span><span class="lineCov">      10766 :    if (name_i == work_i &amp;&amp; work != NULL)</span>
<span class="lineNum">     271 </span>            :       return work;
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineCov">       8850 :    for (lib_list_t *it = loaded; it != NULL; it = it-&gt;next) {</span>
<span class="lineNum">     274 </span><span class="lineCov">       7854 :       if (lib_name(it-&gt;item) == name_i)</span>
<span class="lineNum">     275 </span>            :          return it-&gt;item;
<span class="lineNum">     276 </span>            :    }
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            :    return NULL;
<a name="279"><span class="lineNum">     279 </span>            : }</a>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineCov">        388 : lib_t lib_new(const char *name, const char *path)</span>
<span class="lineNum">     282 </span>            : {
<span class="lineNum">     283 </span><span class="lineCov">        388 :    ident_t name_i = upcase_name(name);</span>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineCov">        388 :    lib_t lib = lib_loaded(name_i);</span>
<span class="lineNum">     286 </span><span class="lineCov">        388 :    if (lib != NULL)</span>
<span class="lineNum">     287 </span>            :       return lib;
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineCov">        776 :    char *name_copy LOCAL = xstrdup(name);</span>
<span class="lineNum">     290 </span><span class="lineCov">        388 :    char *sep = strrchr(name_copy, '/');</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            :    // Ignore trailing slashes
<span class="lineNum">     293 </span><span class="lineCov">        776 :    while ((sep != NULL) &amp;&amp; (*(sep + 1) == '\0')) {</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :       *sep = '\0';</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       sep = strrchr(name_copy, '/');</span>
<span class="lineNum">     296 </span>            :    }
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineCov">        388 :    if (sep != NULL) {</span>
<span class="lineNum">     299 </span>            :       // Work library contains explicit path
<span class="lineNum">     300 </span><span class="lineCov">         27 :       *sep = '\0';</span>
<span class="lineNum">     301 </span><span class="lineCov">         27 :       name = sep + 1;</span>
<span class="lineNum">     302 </span><span class="lineCov">         27 :       lib = lib_find_at(name, name_copy, false);</span>
<span class="lineNum">     303 </span>            :    }
<span class="lineNum">     304 </span>            :    else {
<span class="lineNum">     305 </span>            :       // Look only in working directory
<span class="lineNum">     306 </span><span class="lineCov">        361 :       lib = lib_find_at(name, &quot;.&quot;, false);</span>
<span class="lineNum">     307 </span>            :    }
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineCov">        388 :    if (lib != NULL)</span>
<span class="lineNum">     310 </span>            :       return lib;
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineCov">        345 :    const char *last_slash = strrchr(name, '/');</span>
<span class="lineNum">     313 </span><span class="lineCov">        345 :    const char *last_dot = strrchr(name, '.');</span>
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineCov">        345 :    if ((last_dot != NULL) &amp;&amp; (last_dot &gt; last_slash)) {</span>
<span class="lineNum">     316 </span><span class="lineCov">          1 :       const char *ext = standard_suffix(standard());</span>
<span class="lineNum">     317 </span><span class="lineCov">          1 :       if (strcmp(last_dot + 1, ext) != 0)</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :          fatal(&quot;library directory suffix must be '%s' for this standard&quot;, ext);</span>
<span class="lineNum">     319 </span>            :    }
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineCov">       2087 :    for (const char *p = (last_slash ? last_slash + 1 : name);</span>
<span class="lineNum">     322 </span><span class="lineCov">       3140 :         (*p != '\0') &amp;&amp; (p != last_dot);</span>
<span class="lineNum">     323 </span><span class="lineCov">       1397 :         p++) {</span>
<span class="lineNum">     324 </span><span class="lineCov">       1397 :       if (!isalnum((int)*p) &amp;&amp; (*p != '_'))</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :          fatal(&quot;invalid character '%c' in library name&quot;, *p);</span>
<span class="lineNum">     326 </span>            :    }
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineCov">        690 :    char *lockf LOCAL = xasprintf(&quot;%s/%s&quot;, path, &quot;_NVC_LIB&quot;);</span>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            :    struct stat buf;
<span class="lineNum">     331 </span><span class="lineCov">        345 :    if (stat(path, &amp;buf) == 0) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :       if (S_ISDIR(buf.st_mode)) {</span>
<span class="lineNum">     333 </span>            :          struct stat sb;
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :          if (stat(lockf, &amp;sb) != 0 &amp;&amp; !opt_get_int(&quot;force-init&quot;))</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :             fatal(&quot;directory %s already exists and is not an NVC library &quot;</span>
<span class="lineNum">     336 </span>            :                   &quot;(use --force-init to override this check)&quot;, path);
<span class="lineNum">     337 </span>            :       }
<span class="lineNum">     338 </span>            :       else
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :          fatal(&quot;path %s already exists and is not a directory&quot;, path);</span>
<span class="lineNum">     340 </span>            :    }
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineCov">        345 :    make_dir(path);</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineCov">        690 :    int fd = open(lockf, O_CREAT | O_EXCL | O_RDWR, 0777);</span>
<span class="lineNum">     345 </span><span class="lineCov">        345 :    if (fd &lt; 0) {</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :       if (errno != EEXIST)</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :          fatal_errno(&quot;lib_new: %s&quot;, lockf);</span>
<span class="lineNum">     348 </span>            :    }
<span class="lineNum">     349 </span>            :    else {
<span class="lineNum">     350 </span><span class="lineCov">        345 :       file_write_lock(fd);</span>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineCov">        345 :       const char *marker = PACKAGE_STRING &quot;\n&quot;;</span>
<span class="lineNum">     353 </span><span class="lineCov">        345 :       if (write(fd, marker, strlen(marker)) &lt; 0)</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :          fatal_errno(&quot;write: %s&quot;, path);</span>
<span class="lineNum">     355 </span>            :    }
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineCov">        345 :    return lib_init(name, path, fd);</span>
<a name="358"><span class="lineNum">     358 </span>            : }</a>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span><span class="lineCov">        290 : lib_t lib_tmp(const char *name)</span>
<span class="lineNum">     361 </span>            : {
<span class="lineNum">     362 </span>            :    // For unit tests, avoids creating files
<span class="lineNum">     363 </span><span class="lineCov">        290 :    return lib_init(name, &quot;&quot;, 0);</span>
<a name="364"><span class="lineNum">     364 </span>            : }</a>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineCov">       2176 : static void push_path(const char *path)</span>
<span class="lineNum">     367 </span>            : {
<span class="lineNum">     368 </span><span class="lineCov">       2176 :    search_path_t *s = xmalloc(sizeof(search_path_t));</span>
<span class="lineNum">     369 </span><span class="lineCov">       2176 :    s-&gt;next = search_paths;</span>
<span class="lineNum">     370 </span><span class="lineCov">       2176 :    s-&gt;path = path;</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineCov">       2176 :    search_paths = s;</span>
<a name="373"><span class="lineNum">     373 </span><span class="lineCov">       2176 : }</span></a>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">        905 : static void lib_default_search_paths(void)</span>
<span class="lineNum">     376 </span>            : {
<span class="lineNum">     377 </span><span class="lineCov">        905 :    if (search_paths == NULL) {</span>
<span class="lineNum">     378 </span><span class="lineCov">        634 :       push_path(DATADIR);</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineCov">        634 :       const char *home_env = getenv(&quot;HOME&quot;);</span>
<span class="lineNum">     381 </span><span class="lineCov">        634 :       if (home_env) {</span>
<span class="lineNum">     382 </span>            :          char *path;
<span class="lineNum">     383 </span><span class="lineCov">        634 :          if (asprintf(&amp;path, &quot;%s/.%s/lib&quot;, home_env, PACKAGE) &lt; 0)</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :             fatal_errno(&quot;asprintf&quot;);</span>
<span class="lineNum">     385 </span><span class="lineCov">        634 :          push_path(path);</span>
<span class="lineNum">     386 </span>            :       }
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineCov">        634 :       char *env_copy = NULL;</span>
<span class="lineNum">     389 </span><span class="lineCov">        634 :       const char *libpath_env = getenv(&quot;NVC_LIBPATH&quot;);</span>
<span class="lineNum">     390 </span><span class="lineCov">        634 :       if (libpath_env) {</span>
<span class="lineNum">     391 </span><span class="lineCov">        610 :          env_copy = strdup(libpath_env);</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineCov">        610 :          char *path_tok = strtok(env_copy, &quot;:&quot;);</span>
<span class="lineNum">     394 </span>            :          do {
<span class="lineNum">     395 </span><span class="lineCov">        610 :             push_path(path_tok);</span>
<span class="lineNum">     396 </span><span class="lineCov">        610 :          } while ((path_tok = strtok(NULL, &quot;:&quot;)));</span>
<span class="lineNum">     397 </span>            :       }
<span class="lineNum">     398 </span>            :    }
<a name="399"><span class="lineNum">     399 </span><span class="lineCov">        905 : }</span></a>
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span><span class="lineNoCov">          0 : const char *lib_enum_search_paths(void **token)</span>
<span class="lineNum">     402 </span>            : {
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :    if (*token == NULL) {</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :       lib_default_search_paths();</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :       *token = search_paths;</span>
<span class="lineNum">     406 </span>            :    }
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :    if (*token == (void *)-1)</span>
<span class="lineNum">     409 </span>            :       return NULL;
<span class="lineNum">     410 </span>            :    else {
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       search_path_t *old = *token;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :       if ((*token = old-&gt;next) == NULL)</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :          *token = (void *)-1;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :       return old-&gt;path;</span>
<span class="lineNum">     415 </span>            :    }
<a name="416"><span class="lineNum">     416 </span>            : }</a>
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineCov">        298 : void lib_add_search_path(const char *path)</span>
<span class="lineNum">     419 </span>            : {
<span class="lineNum">     420 </span><span class="lineCov">        298 :    lib_default_search_paths();</span>
<span class="lineNum">     421 </span><span class="lineCov">        298 :    push_path(strdup(path));</span>
<a name="422"><span class="lineNum">     422 </span><span class="lineCov">        298 : }</span></a>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineNoCov">          0 : void lib_add_map(const char *name, const char *path)</span>
<span class="lineNum">     425 </span>            : {
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :    lib_t lib = lib_find_at(name, path, true);</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :    if (lib == NULL)</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :       warnf(&quot;library %s not found at %s&quot;, name, path);</span>
<a name="429"><span class="lineNum">     429 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">       9875 : lib_t lib_find(ident_t name_i, bool required)</span>
<span class="lineNum">     432 </span>            : {
<span class="lineNum">     433 </span><span class="lineCov">       9875 :    lib_t lib = lib_loaded(name_i);</span>
<span class="lineNum">     434 </span><span class="lineCov">       9875 :    if (lib != NULL)</span>
<span class="lineNum">     435 </span>            :       return lib;
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineCov">        607 :    lib_default_search_paths();</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineCov">        607 :    const char *name_str = istr(name_i);</span>
<span class="lineNum">     440 </span><span class="lineCov">        607 :    for (search_path_t *it = search_paths; it != NULL; it = it-&gt;next) {</span>
<span class="lineNum">     441 </span><span class="lineCov">        607 :       if ((lib = lib_find_at(name_str, it-&gt;path, false)))</span>
<span class="lineNum">     442 </span>            :          break;
<span class="lineNum">     443 </span>            :    }
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">        607 :    if (lib == NULL) {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       text_buf_t *tb = tb_new();</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       tb_printf(tb, &quot;library %s not found in:\n&quot;, name_str);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       for (search_path_t *it = search_paths; it != NULL; it = it-&gt;next)</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :          tb_printf(tb, &quot;  %s\n&quot;, it-&gt;path);</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       if (required)</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :          fatal(&quot;%s&quot;, tb_get(tb));</span>
<span class="lineNum">     452 </span>            :       else
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :          errorf(&quot;%s&quot;, tb_get(tb));</span>
<span class="lineNum">     454 </span>            :    }
<span class="lineNum">     455 </span>            : 
<span class="lineNum">     456 </span><span class="lineCov">        607 :    return lib;</span>
<a name="457"><span class="lineNum">     457 </span>            : }</a>
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineCov">        398 : FILE *lib_fopen(lib_t lib, const char *name, const char *mode)</span>
<span class="lineNum">     460 </span>            : {
<span class="lineNum">     461 </span><span class="lineCov">        398 :    assert(lib != NULL);</span>
<span class="lineNum">     462 </span><span class="lineCov">        398 :    return fopen(lib_file_path(lib, name), mode);</span>
<a name="463"><span class="lineNum">     463 </span>            : }</a>
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineCov">       7180 : fbuf_t *lib_fbuf_open(lib_t lib, const char *name, fbuf_mode_t mode)</span>
<span class="lineNum">     466 </span>            : {
<span class="lineNum">     467 </span><span class="lineCov">       7180 :    assert(lib != NULL);</span>
<span class="lineNum">     468 </span><span class="lineCov">       7180 :    return fbuf_open(lib_file_path(lib, name), mode);</span>
<a name="469"><span class="lineNum">     469 </span>            : }</a>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineCov">         10 : void lib_free(lib_t lib)</span>
<span class="lineNum">     472 </span>            : {
<span class="lineNum">     473 </span><span class="lineCov">         10 :    assert(lib != NULL);</span>
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineCov">         20 :    for (lib_list_t *it = loaded, *prev = NULL;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         it != NULL; loaded = it, it = it-&gt;next) {</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineCov">         10 :       if (it-&gt;item == lib) {</span>
<span class="lineNum">     479 </span>            :          if (prev)
<span class="lineNum">     480 </span>            :             prev-&gt;next = it-&gt;next;
<span class="lineNum">     481 </span>            :          else
<span class="lineNum">     482 </span><span class="lineCov">         10 :             loaded = it-&gt;next;</span>
<span class="lineNum">     483 </span><span class="lineCov">         10 :          free(it);</span>
<span class="lineNum">     484 </span><span class="lineCov">         10 :          break;</span>
<span class="lineNum">     485 </span>            :       }
<span class="lineNum">     486 </span>            :    }
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineCov">         10 :    if (lib-&gt;units != NULL)</span>
<span class="lineNum">     489 </span><span class="lineCov">          1 :       free(lib-&gt;units);</span>
<span class="lineNum">     490 </span><span class="lineCov">         10 :    free(lib);</span>
<a name="491"><span class="lineNum">     491 </span><span class="lineCov">         10 : }</span></a>
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineCov">          1 : void lib_destroy(lib_t lib)</span>
<span class="lineNum">     494 </span>            : {
<span class="lineNum">     495 </span>            :    // This is convenience function for testing: remove all
<span class="lineNum">     496 </span>            :    // files associated with a library
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineCov">          1 :    assert(lib != NULL);</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineCov">          1 :    DIR *d = opendir(lib-&gt;path);</span>
<span class="lineNum">     501 </span><span class="lineCov">          1 :    if (d == NULL) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :       perror(&quot;opendir&quot;);</span>
<span class="lineNum">     503 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">     504 </span>            :    }
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :    char buf[PATH_MAX];
<span class="lineNum">     507 </span>            :    struct dirent *e;
<span class="lineNum">     508 </span><span class="lineCov">          8 :    while ((e = readdir(d))) {</span>
<span class="lineNum">     509 </span><span class="lineCov">          7 :       if (e-&gt;d_name[0] != '.') {</span>
<span class="lineNum">     510 </span><span class="lineCov">          5 :          snprintf(buf, sizeof(buf), &quot;%s/%s&quot;, lib-&gt;path, e-&gt;d_name);</span>
<span class="lineNum">     511 </span><span class="lineCov">          5 :          if (unlink(buf) &lt; 0)</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :             perror(&quot;unlink&quot;);</span>
<span class="lineNum">     513 </span>            :       }
<span class="lineNum">     514 </span>            :    }
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineCov">          1 :    closedir(d);</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineCov">          1 :    if (rmdir(lib-&gt;path) &lt; 0)</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :       perror(&quot;rmdir&quot;);</span>
<a name="520"><span class="lineNum">     520 </span>            : }</a>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineCov">      16195 : lib_t lib_work(void)</span>
<span class="lineNum">     523 </span>            : {
<span class="lineNum">     524 </span><span class="lineCov">      16195 :    assert(work != NULL);</span>
<span class="lineNum">     525 </span><span class="lineCov">      16195 :    return work;</span>
<a name="526"><span class="lineNum">     526 </span>            : }</a>
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineCov">        677 : void lib_set_work(lib_t lib)</span>
<span class="lineNum">     529 </span>            : {
<span class="lineNum">     530 </span><span class="lineCov">        677 :    work = lib;</span>
<a name="531"><span class="lineNum">     531 </span><span class="lineCov">        677 : }</span></a>
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span><span class="lineNoCov">          0 : const char *lib_path(lib_t lib)</span>
<span class="lineNum">     534 </span>            : {
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :    assert(lib != NULL);</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :    return lib-&gt;path;</span>
<a name="537"><span class="lineNum">     537 </span>            : }</a>
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineCov">       5545 : static lib_mtime_t lib_time_to_usecs(time_t t)</span>
<span class="lineNum">     540 </span>            : {
<span class="lineNum">     541 </span><span class="lineCov">       5545 :    return (lib_mtime_t)t * 1000 * 1000;</span>
<a name="542"><span class="lineNum">     542 </span>            : }</a>
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span><span class="lineCov">       2130 : void lib_put(lib_t lib, tree_t unit)</span>
<span class="lineNum">     545 </span>            : {
<span class="lineNum">     546 </span>            :    struct timeval tv;
<span class="lineNum">     547 </span><span class="lineCov">       2130 :    if (gettimeofday(&amp;tv, NULL) != 0)</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       fatal_errno(&quot;gettimeofday&quot;);</span>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span><span class="lineCov">       2130 :    lib_mtime_t usecs = ((lib_mtime_t)tv.tv_sec * 1000000) + tv.tv_usec;</span>
<span class="lineNum">     551 </span><span class="lineCov">       2130 :    lib_put_aux(lib, unit, NULL, true, usecs);</span>
<a name="552"><span class="lineNum">     552 </span><span class="lineCov">       2130 : }</span></a>
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span><span class="lineCov">       5545 : static lib_mtime_t lib_stat_mtime(struct stat *st)</span>
<span class="lineNum">     555 </span>            : {
<span class="lineNum">     556 </span><span class="lineCov">       5545 :    lib_mtime_t mt = lib_time_to_usecs(st-&gt;st_mtime);</span>
<span class="lineNum">     557 </span>            : #if defined HAVE_STRUCT_STAT_ST_MTIMESPEC_TV_NSEC
<span class="lineNum">     558 </span>            :    mt += st-&gt;st_mtimespec.tv_nsec / 1000;
<span class="lineNum">     559 </span>            : #elif defined HAVE_STRUCT_STAT_ST_MTIM_TV_NSEC
<span class="lineNum">     560 </span><span class="lineCov">       5545 :    mt += st-&gt;st_mtim.tv_nsec / 1000;</span>
<span class="lineNum">     561 </span>            : #endif
<span class="lineNum">     562 </span><span class="lineCov">       5545 :    return mt;</span>
<a name="563"><span class="lineNum">     563 </span>            : }</a>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineCov">       8750 : static lib_unit_t *lib_get_aux(lib_t lib, ident_t ident)</span>
<span class="lineNum">     566 </span>            : {
<span class="lineNum">     567 </span><span class="lineCov">       8719 :    assert(lib != NULL);</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span>            :    // Handle aliased library names
<span class="lineNum">     570 </span><span class="lineCov">       8719 :    ident_t lname = ident_until(ident, '.');</span>
<span class="lineNum">     571 </span><span class="lineCov">       8719 :    if ((lname != NULL) &amp;&amp; (lname != lib-&gt;name)) {</span>
<span class="lineNum">     572 </span><span class="lineCov">         16 :       ident_t uname = ident_rfrom(ident, '.');</span>
<span class="lineNum">     573 </span><span class="lineCov">         16 :       if (uname != NULL)</span>
<span class="lineNum">     574 </span><span class="lineCov">         14 :          ident = ident_prefix(lib-&gt;name, uname, '.');</span>
<span class="lineNum">     575 </span>            :    }
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span>            :    // Search in the list of already loaded units
<span class="lineNum">     578 </span><span class="lineCov">      17536 :    for (unsigned n = 0; n &lt; lib-&gt;n_units; n++) {</span>
<span class="lineNum">     579 </span><span class="lineCov">      16265 :       if (tree_ident(lib-&gt;units[n].top) == ident)</span>
<span class="lineNum">     580 </span><span class="lineCov">       7448 :          return &amp;(lib-&gt;units[n]);</span>
<span class="lineNum">     581 </span>            :    }
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span><span class="lineCov">       1271 :    if (*(lib-&gt;path) == '\0')   // Temporary library</span>
<span class="lineNum">     584 </span>            :       return NULL;
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineCov">       1123 :    file_read_lock(lib-&gt;lock_fd);</span>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span>            :    // Otherwise search in the filesystem
<span class="lineNum">     589 </span><span class="lineCov">       1123 :    DIR *d = opendir(lib-&gt;path);</span>
<span class="lineNum">     590 </span><span class="lineCov">       1123 :    if (d == NULL)</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :       fatal(&quot;%s: %s&quot;, lib-&gt;path, strerror(errno));</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span><span class="lineCov">       1123 :    lib_unit_t *unit = NULL;</span>
<span class="lineNum">     594 </span><span class="lineCov">       1123 :    const char *search = istr(ident);</span>
<span class="lineNum">     595 </span>            :    struct dirent *e;
<span class="lineNum">     596 </span><span class="lineCov">       1123 :    while ((e = readdir(d))) {</span>
<span class="lineNum">     597 </span><span class="lineCov">       7086 :       if (strcmp(e-&gt;d_name, search) == 0) {</span>
<span class="lineNum">     598 </span><span class="lineCov">       1092 :          fbuf_t *f = lib_fbuf_open(lib, e-&gt;d_name, FBUF_IN);</span>
<span class="lineNum">     599 </span><span class="lineCov">       1092 :          tree_rd_ctx_t ctx = tree_read_begin(f, lib_file_path(lib, e-&gt;d_name));</span>
<span class="lineNum">     600 </span><span class="lineCov">       1092 :          tree_t top = tree_read(ctx);</span>
<span class="lineNum">     601 </span><span class="lineCov">       1092 :          fbuf_close(f);</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            :          struct stat st;
<span class="lineNum">     604 </span><span class="lineCov">       1092 :          if (stat(lib_file_path(lib, e-&gt;d_name), &amp;st) &lt; 0)</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :             fatal_errno(&quot;%s&quot;, e-&gt;d_name);</span>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">       1092 :          lib_mtime_t mt = lib_stat_mtime(&amp;st);</span>
<span class="lineNum">     608 </span>            : 
<span class="lineNum">     609 </span><span class="lineCov">       1092 :          unit = lib_put_aux(lib, top, ctx, false, mt);</span>
<span class="lineNum">     610 </span>            :          break;
<span class="lineNum">     611 </span>            :       }
<span class="lineNum">     612 </span>            :    }
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineCov">       1123 :    closedir(d);</span>
<span class="lineNum">     615 </span><span class="lineCov">       1123 :    file_unlock(lib-&gt;lock_fd);</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span><span class="lineCov">       1154 :    if (unit == NULL &amp;&amp; lib_find_in_index(lib, ident) != NULL)</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :       fatal(&quot;library %s corrupt: unit %s present in index but missing &quot;</span>
<span class="lineNum">     619 </span>            :             &quot;on disk&quot;, istr(lib-&gt;name), istr(ident));
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :    return unit;
<a name="622"><span class="lineNum">     622 </span>            : }</a>
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span><span class="lineCov">          2 : lib_mtime_t lib_mtime(lib_t lib, ident_t ident)</span>
<span class="lineNum">     625 </span>            : {
<span class="lineNum">     626 </span><span class="lineCov">          2 :    lib_unit_t *lu = lib_get_aux(lib, ident);</span>
<span class="lineNum">     627 </span><span class="lineCov">          2 :    assert(lu != NULL);</span>
<span class="lineNum">     628 </span><span class="lineCov">          2 :    return lu-&gt;mtime;</span>
<a name="629"><span class="lineNum">     629 </span>            : }</a>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineNoCov">          0 : bool lib_stat(lib_t lib, const char *name, lib_mtime_t *mt)</span>
<span class="lineNum">     632 </span>            : {
<span class="lineNum">     633 </span>            :    struct stat buf;
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :    if (stat(lib_file_path(lib, name), &amp;buf) == 0) {</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :       if (mt != NULL)</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :          *mt = lib_stat_mtime(&amp;buf);</span>
<span class="lineNum">     637 </span>            :       return true;
<span class="lineNum">     638 </span>            :    }
<span class="lineNum">     639 </span>            :    else
<span class="lineNum">     640 </span>            :       return false;
<a name="641"><span class="lineNum">     641 </span>            : }</a>
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">       3002 : tree_t lib_get(lib_t lib, ident_t ident)</span>
<span class="lineNum">     644 </span>            : {
<span class="lineNum">     645 </span><span class="lineCov">       3002 :    lib_unit_t *lu = lib_get_aux(lib, ident);</span>
<span class="lineNum">     646 </span><span class="lineCov">       3002 :    if (lu != NULL) {</span>
<span class="lineNum">     647 </span><span class="lineCov">       2964 :       if (lu-&gt;read_ctx != NULL) {</span>
<span class="lineNum">     648 </span><span class="lineCov">         82 :          tree_read_end(lu-&gt;read_ctx);</span>
<span class="lineNum">     649 </span><span class="lineCov">         82 :          lu-&gt;read_ctx = NULL;</span>
<span class="lineNum">     650 </span>            :       }
<span class="lineNum">     651 </span><span class="lineCov">       2964 :       return lu-&gt;top;</span>
<span class="lineNum">     652 </span>            :    }
<span class="lineNum">     653 </span>            :    else
<span class="lineNum">     654 </span>            :       return NULL;
<a name="655"><span class="lineNum">     655 </span>            : }</a>
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span><span class="lineCov">       5715 : tree_t lib_get_check_stale(lib_t lib, ident_t ident)</span>
<span class="lineNum">     658 </span>            : {
<span class="lineNum">     659 </span><span class="lineCov">       5715 :    lib_unit_t *lu = lib_get_aux(lib, ident);</span>
<span class="lineNum">     660 </span><span class="lineCov">       5715 :    if (lu != NULL) {</span>
<span class="lineNum">     661 </span><span class="lineCov">       5574 :       if (lu-&gt;read_ctx != NULL) {</span>
<span class="lineNum">     662 </span><span class="lineCov">       1010 :          tree_read_end(lu-&gt;read_ctx);</span>
<span class="lineNum">     663 </span><span class="lineCov">       1010 :          lu-&gt;read_ctx = NULL;</span>
<span class="lineNum">     664 </span>            :       }
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span><span class="lineCov">       5574 :       if (!opt_get_int(&quot;ignore-time&quot;)) {</span>
<span class="lineNum">     667 </span><span class="lineCov">       5574 :          const loc_t *loc = tree_loc(lu-&gt;top);</span>
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span>            :          struct stat st;
<span class="lineNum">     670 </span><span class="lineCov">       5574 :          if (stat(istr(loc-&gt;file), &amp;st) == 0 &amp;&amp; lu-&gt;mtime &lt; lib_stat_mtime(&amp;st))</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :             fatal(&quot;design unit %s is older than its source file %s and must &quot;</span>
<span class="lineNum">     672 </span>            :                   &quot;be reanalysed\n(You can use the --ignore-time option to &quot;
<span class="lineNum">     673 </span>            :                   &quot;skip this check)&quot;, istr(ident), istr(loc-&gt;file));
<span class="lineNum">     674 </span>            :       }
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span><span class="lineCov">       5574 :       return lu-&gt;top;</span>
<span class="lineNum">     677 </span>            :    }
<span class="lineNum">     678 </span>            :    else
<span class="lineNum">     679 </span>            :       return NULL;
<a name="680"><span class="lineNum">     680 </span>            : }</a>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineCov">      17878 : ident_t lib_name(lib_t lib)</span>
<span class="lineNum">     683 </span>            : {
<span class="lineNum">     684 </span><span class="lineCov">      17878 :    assert(lib != NULL);</span>
<span class="lineNum">     685 </span><span class="lineCov">      17878 :    return lib-&gt;name;</span>
<a name="686"><span class="lineNum">     686 </span>            : }</a>
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span><span class="lineCov">        700 : void lib_save(lib_t lib)</span>
<span class="lineNum">     689 </span>            : {
<span class="lineNum">     690 </span><span class="lineCov">        700 :    assert(lib != NULL);</span>
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span><span class="lineCov">        700 :    file_write_lock(lib-&gt;lock_fd);</span>
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span><span class="lineCov">       3246 :    for (unsigned n = 0; n &lt; lib-&gt;n_units; n++) {</span>
<span class="lineNum">     695 </span><span class="lineCov">       2546 :       if (lib-&gt;units[n].dirty) {</span>
<span class="lineNum">     696 </span><span class="lineCov">       1280 :          const char *name = istr(tree_ident(lib-&gt;units[n].top));</span>
<span class="lineNum">     697 </span><span class="lineCov">       1280 :          fbuf_t *f = lib_fbuf_open(lib, name, FBUF_OUT);</span>
<span class="lineNum">     698 </span><span class="lineCov">       1280 :          if (f == NULL)</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :             fatal(&quot;failed to create %s in library %s&quot;, name, istr(lib-&gt;name));</span>
<span class="lineNum">     700 </span><span class="lineCov">       1280 :          tree_wr_ctx_t ctx = tree_write_begin(f);</span>
<span class="lineNum">     701 </span><span class="lineCov">       1280 :          tree_write(lib-&gt;units[n].top, ctx);</span>
<span class="lineNum">     702 </span><span class="lineCov">       1280 :          tree_write_end(ctx);</span>
<span class="lineNum">     703 </span><span class="lineCov">       1280 :          fbuf_close(f);</span>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineCov">       1280 :          lib-&gt;units[n].dirty = false;</span>
<span class="lineNum">     706 </span>            :       }
<span class="lineNum">     707 </span>            :    }
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            :    lib_index_t *it;
<span class="lineNum">     710 </span><span class="lineCov">        700 :    int index_sz = 0;</span>
<span class="lineNum">     711 </span><span class="lineCov">        700 :    for (it = lib-&gt;index; it != NULL; it = it-&gt;next, ++index_sz)</span>
<span class="lineNum">     712 </span>            :       ;
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span><span class="lineCov">        700 :    fbuf_t *f = lib_fbuf_open(lib, &quot;_index&quot;, FBUF_OUT);</span>
<span class="lineNum">     715 </span><span class="lineCov">        700 :    if (f == NULL)</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :       fatal(&quot;failed to create library %s index&quot;, istr(lib-&gt;name));</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">        700 :    ident_wr_ctx_t ictx = ident_write_begin(f);</span>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineCov">        700 :    write_u32(index_sz, f);</span>
<span class="lineNum">     721 </span><span class="lineCov">       3077 :    for (it = lib-&gt;index; it != NULL; it = it-&gt;next) {</span>
<span class="lineNum">     722 </span><span class="lineCov">       2377 :       ident_write(it-&gt;name, ictx);</span>
<span class="lineNum">     723 </span><span class="lineCov">       2377 :       write_u16(it-&gt;kind, f);</span>
<span class="lineNum">     724 </span>            :    }
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span><span class="lineCov">        700 :    ident_write_end(ictx);</span>
<span class="lineNum">     727 </span><span class="lineCov">        700 :    fbuf_close(f);</span>
<span class="lineNum">     728 </span><span class="lineCov">        700 :    file_unlock(lib-&gt;lock_fd);</span>
<a name="729"><span class="lineNum">     729 </span><span class="lineCov">        700 : }</span></a>
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineCov">       1325 : int lib_index_kind(lib_t lib, ident_t ident)</span>
<span class="lineNum">     732 </span>            : {
<span class="lineNum">     733 </span><span class="lineCov">       1325 :    assert(lib != NULL);</span>
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span>            :    lib_index_t *it;
<span class="lineNum">     736 </span><span class="lineCov">       3927 :    for (it = lib-&gt;index; it != NULL; it = it-&gt;next) {</span>
<span class="lineNum">     737 </span><span class="lineCov">       3927 :       if (it-&gt;name == ident)</span>
<span class="lineNum">     738 </span><span class="lineCov">       1325 :          return it-&gt;kind;</span>
<span class="lineNum">     739 </span>            :    }
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span>            :    return T_LAST_TREE_KIND;
<a name="742"><span class="lineNum">     742 </span>            : }</a>
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span><span class="lineCov">        723 : void lib_walk_index(lib_t lib, lib_index_fn_t fn, void *context)</span>
<span class="lineNum">     745 </span>            : {
<span class="lineNum">     746 </span><span class="lineCov">        723 :    assert(lib != NULL);</span>
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span>            :    lib_index_t *it;
<span class="lineNum">     749 </span><span class="lineCov">       3264 :    for (it = lib-&gt;index; it != NULL; it = it-&gt;next)</span>
<span class="lineNum">     750 </span><span class="lineCov">       2541 :       (*fn)(it-&gt;name, it-&gt;kind, context);</span>
<a name="751"><span class="lineNum">     751 </span><span class="lineCov">        723 : }</span></a>
<span class="lineNum">     752 </span>            : 
<span class="lineNum">     753 </span><span class="lineNoCov">          0 : unsigned lib_index_size(lib_t lib)</span>
<span class="lineNum">     754 </span>            : {
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :    assert(lib != NULL);</span>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :    unsigned n = 0;</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :    for (lib_index_t *it = lib-&gt;index; it != NULL; it = it-&gt;next)</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :       n++;</span>
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :    return n;</span>
<a name="762"><span class="lineNum">     762 </span>            : }</a>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineCov">       1101 : void lib_realpath(lib_t lib, const char *name, char *buf, size_t buflen)</span>
<span class="lineNum">     765 </span>            : {
<span class="lineNum">     766 </span><span class="lineCov">       1101 :    assert(lib != NULL);</span>
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineCov">       1101 :    if (name)</span>
<span class="lineNum">     769 </span><span class="lineCov">       1101 :       snprintf(buf, buflen, &quot;%s/%s&quot;, lib-&gt;path, name);</span>
<span class="lineNum">     770 </span>            :    else
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :       strncpy(buf, lib-&gt;path, buflen);</span>
<a name="772"><span class="lineNum">     772 </span><span class="lineCov">       1101 : }</span></a>
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span><span class="lineCov">          1 : void lib_mkdir(lib_t lib, const char *name)</span>
<span class="lineNum">     775 </span>            : {
<span class="lineNum">     776 </span><span class="lineCov">          1 :    make_dir(lib_file_path(lib, name));</span>
<a name="777"><span class="lineNum">     777 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span><span class="lineCov">        935 : void lib_delete(lib_t lib, const char *name)</span>
<span class="lineNum">     780 </span>            : {
<span class="lineNum">     781 </span><span class="lineCov">        935 :    assert(lib != NULL);</span>
<span class="lineNum">     782 </span><span class="lineCov">        935 :    if (remove(lib_file_path(lib, name)) != 0 &amp;&amp; errno != ENOENT)</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :       fatal_errno(&quot;remove: %s&quot;, name);</span>
<span class="lineNum">     784 </span><span class="lineCov">        935 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
